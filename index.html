<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Annotation Tool</title>
    <style>
        #image-container {
            position: relative;
            margin-top: 20px;
        }
        #image {
            width: 100%; /* Ensure it fits the container */
        }
        #file-list {
            max-height: 150px; /* Set a max height for the scrollable area */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid #ccc; /* Optional: add a border for better visibility */
            margin-top: 10px;
            padding: 5px;
        }
        .file-item {
            cursor: pointer; /* Change cursor on hover */
            padding: 5px;
        }
        .file-item:hover {
            background-color: #f0f0f0; /* Highlight on hover */
        }
        .point {
            width: 10px;
            height: 10px;
            background-color: red;
            border-radius: 50%;
            position: absolute;
        }
    </style>
</head>
<body>
    <h1>Image Annotation Tool</h1>

    <!-- File Upload -->
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="file" id="file-input" multiple>
        <button type="submit">Upload</button>
    </form>

    <!-- Scrollable list for uploaded files -->
    <div id="file-list"></div>

    <!-- Image display -->
    <div id="image-container">
        <img id="image" src="" alt="Image will be displayed here">
    </div>

    <script>
        let points = [];
        const fileList = document.getElementById("file-list");
        const imageElement = document.getElementById("image");

        // Upload Form Handler
        document.getElementById("upload-form").addEventListener("submit", function(event) {
            event.preventDefault();
            
            const formData = new FormData(this);
            fetch("/upload", {
                method: "POST",
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.status === "File uploaded") {
                    data.file_paths.forEach(filePath => {
                        addFileToList(filePath); // Add each uploaded file path to the list
                    });
                    // Optionally display the first uploaded image
                    if (!imageElement.src && data.file_paths.length > 0) {
                        imageElement.src = data.file_paths[0]; // Show the first uploaded image
                    }
                } else {
                    console.error("File upload failed", data);
                }
            })
            .catch(error => {
                console.error("Error uploading file:", error);
            });
        });

        function addFileToList(filePath) {
            const fileItem = document.createElement("div");
            fileItem.classList.add("file-item");
            fileItem.textContent = filePath.split('/').pop(); // Display only the file name

            fileItem.addEventListener("click", function() {
                imageElement.src = filePath; // Update the main image to the selected file
            });

            fileList.appendChild(fileItem);
        }

        // Image Click Handler (remains unchanged)
        imageElement.addEventListener("click", function(event) {
            const rect = this.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            points.push({x, y});

            // Display the point on the image
            const pointDiv = document.createElement("div");
            pointDiv.classList.add("point");
            pointDiv.style.left = `${x}px`;
            pointDiv.style.top = `${y}px`;
            document.getElementById("image-container").appendChild(pointDiv);

            // Create bounding box after 2 points (you can customize the number)
            if (points.length === 2) {
                createBoundingBox(points);
                points = [];
            }
        });

        function createBoundingBox(points) {
            const minX = Math.min(points[0].x, points[1].x);
            const minY = Math.min(points[0].y, points[1].y);
            const maxX = Math.max(points[0].x, points[1].x);
            const maxY = Math.max(points[0].y, points[1].y);

            const boundingBox = {
                x: minX,
                y: minY,
                width: maxX - minX,
                height: maxY - minY,
            };

            console.log(boundingBox);

            // Send the bounding box to the server
            fetch("/annotate", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(boundingBox),
            }).then(response => response.json())
            .then(data => {
                console.log("Annotation saved", data);
            });
        }
    </script>
</body>
</html>
